<% content_for :title, "Admin Dashboard - User Management" %>
<div>
  <!-- Header -->
  <div class="md:mb-8 mb-4 flex justify-between items-center">
    <div>
      <h1 class="text-3xl font-bold text-gray-900">User Management</h1>
      <p class="text-gray-600">Manage and monitor all users in the system</p>
    </div>
    <div class="flex space-x-3">
      <%= link_to admin_roles_path, 
          class: "bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-lg transition-colors" do %>
        Manage Roles
      <% end %>
    </div>
  </div>
  <!-- Filter Section -->
  <div class="bg-white shadow rounded-lg mb-6">
    <div class="px-6 py-4">
      <div class="flex flex-wrap gap-4 items-center">
        <h3 class="text-sm font-medium text-gray-900">Filter by Role:</h3>
        <!-- All Users Button -->
        <%= link_to admin_path, 
            class: "inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 #{'bg-indigo-100 border-indigo-300 text-indigo-700' if params[:role].blank?}" do %>
          All Users (<%= @total_users %>)
        <% end %>
        <!-- Dynamic Role Buttons -->
        <% @roles.each do |role| %>
          <% 
            # Define colors for different roles
            color_class = case role.name.downcase
                         when 'admin'
                           'bg-purple-100 border-purple-300 text-purple-700'
                         when 'moderator'  
                           'bg-orange-100 border-orange-300 text-orange-700'
                         when 'user'
                           'bg-green-100 border-green-300 text-green-700'
                         else
                           'bg-blue-100 border-blue-300 text-blue-700'
                         end
            active_class = params[:role] == role.name ? color_class : ''
          %>
          <%= link_to admin_path(role: role.name), 
              class: "inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 #{active_class}" do %>
            <%= role.name.titleize %>s (<%= role.user_count %>)
          <% end %>
        <% end %>
      </div>
    </div>
  </div>
  <!-- All Users Table -->
  <div class="bg-white shadow rounded-lg">
    <div class="px-6 py-4 border-b border-gray-200">
      <h2 class="text-lg font-medium text-gray-900">
        <% if params[:role].present? %>
          <%= params[:role].titleize %> Users (<%= @users.total_count %>)
        <% else %>
          All Users (<%= @users.total_count %>)
        <% end %>
      </h2>
    </div>
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Username
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Email
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Role
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Pending
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              In Progress
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Completed
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Cancelled
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Actions
            </th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <% @users.each do |user| %>
            <tr class="hover:bg-gray-50">
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                  <div class="ml-4">
                    <div class="text-sm font-medium text-gray-900">
                      <%= user.username %>
                    </div>
                  </div>
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                <%= user.email_address %>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <% if user.admin? %>
                  <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-purple-100 text-purple-800">
                    <%= user.role.name.titleize %>
                  </span>
                <% else %>
                  <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">
                    <%= user.role.name.titleize %>
                  </span>
                <% end %>
                <% if user != Current.user %>
                  <div class="mt-1">
                    <%= form_with url: admin_update_user_role_path(user), method: :patch, local: true, class: "inline-flex" do |form| %>
                      <%= form.select :role_id, options_from_collection_for_select(Role.all, :id, :name, user.role_id), 
                                      {}, 
                                      { class: "text-xs border border-gray-300 rounded px-2 py-1", 
                                        onchange: "this.form.submit();" } %>
                    <% end %>
                  </div>
                <% end %>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-center">
                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">
                  <%= user.tasks.pending.count %>
                </span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-center">
                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">
                  <%= user.tasks.in_progress.count %>
                </span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-center">
                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">
                  <%= user.tasks.completed.count %>
                </span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-center">
                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">
                  <%= user.tasks.cancelled.count %>
                </span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                <div class="flex space-x-2">
                  <%= link_to admin_user_details_path(user), 
                        class: "text-indigo-600 hover:text-indigo-900 px-2 py-1 rounded bg-indigo-50 hover:bg-indigo-100 transition-colors" do %>
                    View Details
                  <% end %>
                  <% unless user == Current.user %>
                    <%= button_to "Delete", admin_destroy_user_path(user), 
                          method: :delete, 
                          data: { 
                            turbo_confirm: "Are you sure you want to delete user #{user.username}? All related data will be permanently deleted." 
                          },
                          class: "text-red-600 hover:text-red-900 px-2 py-1 rounded bg-red-50 hover:bg-red-100 transition-colors" %>
                  <% else %>
                    <span class="text-gray-400 px-2 py-1 rounded bg-gray-50">
                      You
                    </span>
                  <% end %>
                </div>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
    <% if @users.empty? %>
      <div class="text-center py-8">
        <h3 class="mt-2 text-sm font-medium text-gray-900">No users found</h3>
        <p class="mt-1 text-sm text-gray-500">There are no users in the system.</p>
      </div>
    <% end %>
    <!-- Pagination -->
    <% if @users.total_pages > 1 %>
      <div class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6">
        <div class="flex-1 flex justify-between sm:hidden">
          <%= paginate @users, theme: 'tailwind' %>
        </div>
        <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
          <div>
            <p class="text-sm text-gray-700">
              Showing
              <span class="font-medium"><%= @users.offset_value + 1 %></span>
              to
              <span class="font-medium"><%= [@users.offset_value + @users.limit_value, @users.total_count].min %></span>
              of
              <span class="font-medium"><%= @users.total_count %></span>
              users
            </p>
          </div>
          <div>
            <%= paginate @users, theme: 'tailwind' %>
          </div>
        </div>
      </div>
    <% end %>
  </div>
</div>